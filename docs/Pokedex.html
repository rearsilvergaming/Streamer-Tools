<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Pok√©dex Viewer (Debug Mode)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background: #0a0a0a;
        color: white;
        font-family: Inter, sans-serif;
        text-align: center;
        padding: 20px;
      }
      #dex-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 18px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .dex-entry {
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 10px;
        padding: 10px;
      }
      .dex-entry.caught {
        border-color: #4caf50;
      }
      .dex-entry.shiny {
        border-color: gold;
        box-shadow: 0 0 10px gold;
      }
      .uncaught img {
        filter: grayscale(1) brightness(0.3);
        opacity: 0.4;
      }
      img {
        width: 90px;
        height: 90px;
        object-fit: contain;
      }
    </style>
  </head>

  <body>
    <h1>Pok√©dex (Debug)</h1>
    <div id="username-label"></div>
    <div id="status">Connecting‚Ä¶</div>
    <div id="dex-grid"></div>

    <script>
      console.log("üî• POKEDEX PAGE LOADED");

      const SPRITE_BASE =
        "https://raw.githubusercontent.com/rearsilvergaming/Streamer-Tools/main/docs/Pokemon/";

      const ALL_POKEMON = [
        { num: 1, name: "Bulbasaur" },
        { num: 4, name: "Charmander" },
        { num: 5, name: "Charmeleon" },
        { num: 6, name: "Charizard" },
        { num: 7, name: "Squirtle" },
        { num: 16, name: "Pidgey" },
        { num: 18, name: "Pidgeot" },
        { num: 25, name: "Pikachu" },
        { num: 35, name: "Clefairy" },
        { num: 39, name: "Jigglypuff" },
        { num: 52, name: "Meowth" },
        { num: 54, name: "Psyduck" },
        { num: 59, name: "Arcanine" },
        { num: 79, name: "Slowpoke" },
        { num: 94, name: "Gengar" },
        { num: 132, name: "Ditto" },
        { num: 133, name: "Eevee" },
        { num: 143, name: "Snorlax" },
        { num: 149, name: "Dragonite" },
        { num: 150, name: "Mewtwo" },
        { num: 151, name: "Mew" },
        { num: 197, name: "Umbreon" },
        { num: 727, name: "Incineroar" },
        { num: 778, name: "Mimikyu" },
      ];

      function getParam(k) {
        return new URL(window.location.href).searchParams.get(k);
      }

      const user = getParam("user");
      const userId = getParam("userId");

      document.getElementById("username-label").innerText =
        "Showing Pok√©dex for " + user;

      let ws;

      function connectWS() {
        console.log("üîå Opening WebSocket‚Ä¶");

        ws = new WebSocket("ws://127.0.0.1:8080");

        ws.onopen = () => {
          console.log("üü¢ WEBSOCKET CONNECTED");

          ws.send(
            JSON.stringify({
              request: "TwitchGetUserGlobal",
              id: "pokedexRequest",
              userId: userId,
              variable: "pokedexData",
              persisted: true,
            })
          );
        };

        ws.onmessage = (event) => {
          console.log("üì• RAW MESSAGE:", event.data);
          let msg = JSON.parse(event.data);

          if (msg.id === "pokedexRequest") {
            console.log("üü£ Parsed Message:", msg);

            // Correct extraction
            const dexRaw = msg.variables?.[0]?.value ?? "[]";

            console.log("üì¶ Correct pokedexData raw:", dexRaw);

            let dex = [];
            try {
              dex = JSON.parse(dexRaw);
            } catch (e) {
              console.error("‚ùå JSON parse failed:", e);
            }

            console.log("üìò Parsed userDex:", dex);
            renderDex(dex);
          }
        };

        ws.onclose = () => {
          console.warn("üî¥ WS Closed ‚Äì reconnecting‚Ä¶");
          setTimeout(connectWS, 1000);
        };
      }

      connectWS();

      function renderDex(userDex) {
        const grid = document.getElementById("dex-grid");
        grid.innerHTML = "";

        const caughtMap = {};
        userDex.forEach((mon) => (caughtMap[mon.PokedexNum] = mon));

        ALL_POKEMON.forEach((entry) => {
          const caught = caughtMap[entry.num];

          const cell = document.createElement("div");
          cell.className = "dex-entry " + (caught ? "caught" : "uncaught");
          if (caught?.Shiny) cell.classList.add("shiny");

          const normalTag = caught?.Normal
            ? `<span class="tag-normal">Normal ‚úì</span>`
            : "";
          const shinyTag = caught?.Shiny
            ? `<span class="tag-shiny">Shiny ‚ú®</span>`
            : "";

          cell.innerHTML = `
      <img src="${SPRITE_BASE}${entry.name}.png">
      <div class="dex-number">#${entry.num}</div>
      <div class="dex-name">${entry.name}</div>
      <div class="variant-tags">${normalTag} ${shinyTag}</div>
    `;

          grid.appendChild(cell);
        });
      }
    </script>
  </body>
</html>
