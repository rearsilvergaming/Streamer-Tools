<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PokÃ©dex Viewer (Debug Mode)</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background: #0a0a0a;
        color: white;
        font-family: Inter, sans-serif;
        text-align: center;
        padding: 20px;
      }
      #dex-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 18px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .dex-entry {
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 10px;
        padding: 10px;
      }
      .dex-entry.caught {
        border-color: #4caf50;
      }
      .dex-entry.shiny {
        border-color: gold;
        box-shadow: 0 0 10px gold;
      }
      .uncaught img {
        filter: grayscale(1) brightness(0.3);
        opacity: 0.4;
      }
      img {
        width: 90px;
        height: 90px;
        object-fit: contain;
      }
    </style>
  </head>

  <body>
    <h1>PokÃ©dex (Debug)</h1>
    <div id="username-label"></div>
    <div id="status">Connectingâ€¦</div>
    <div id="dex-grid"></div>

    <script>
      console.log("ðŸ”¥ POKEDEX PAGE LOADED");

      const SPRITE_BASE =
        "https://raw.githubusercontent.com/rearsilvergaming/Streamer-Tools/main/docs/Pokemon/";

      const ALL_POKEMON = [
        { num: 1, name: "Bulbasaur" },
        { num: 4, name: "Charmander" },
        { num: 5, name: "Charmeleon" },
        { num: 6, name: "Charizard" },
        { num: 7, name: "Squirtle" },
        { num: 16, name: "Pidgey" },
        { num: 18, name: "Pidgeot" },
        { num: 25, name: "Pikachu" },
        { num: 35, name: "Clefairy" },
        { num: 39, name: "Jigglypuff" },
        { num: 52, name: "Meowth" },
        { num: 54, name: "Psyduck" },
        { num: 59, name: "Arcanine" },
        { num: 79, name: "Slowpoke" },
        { num: 94, name: "Gengar" },
        { num: 132, name: "Ditto" },
        { num: 133, name: "Eevee" },
        { num: 143, name: "Snorlax" },
        { num: 149, name: "Dragonite" },
        { num: 150, name: "Mewtwo" },
        { num: 151, name: "Mew" },
        { num: 197, name: "Umbreon" },
        { num: 727, name: "Incineroar" },
        { num: 778, name: "Mimikyu" },
      ];

      function getParam(k) {
        return new URL(window.location.href).searchParams.get(k);
      }

      const user = getParam("user");
      const userId = getParam("userId");

      console.log("ðŸ” URL PARAMS:", { user, userId });
      document.getElementById("username-label").innerText =
        "Showing PokÃ©dex for " + user;

      //-------------------------------------------------------
      // WEBSOCKET WITH FULL DEBUG LOGGING
      //-------------------------------------------------------
      let ws;

      function connectWS() {
        console.log("ðŸ”Œ Opening WebSocketâ€¦");

        ws = new WebSocket("ws://127.0.0.1:8080");

        ws.onopen = () => {
          console.log("ðŸŸ¢ WEBSOCKET CONNECTED");
          document.getElementById("status").innerText = "Connected âœ”ï¸";

          const req = {
            request: "TwitchGetUserGlobal",
            id: "pokedexRequest",
            userId: userId,
            variable: "pokedexData",
            persisted: true,
          };

          console.log("ðŸ“¤ Sending request:", req);
          ws.send(JSON.stringify(req));
        };

        ws.onmessage = (event) => {
          console.log("ðŸ“¥ RAW WS MESSAGE:", event.data);

          let msg;
          try {
            msg = JSON.parse(event.data);
          } catch (e) {
            console.error("âŒ WS JSON PARSE FAILED:", e);
            return;
          }

          console.log("ðŸŸ£ Parsed WS Message:", msg);

          if (msg.id === "pokedexRequest") {
            const json = msg?.data?.value ?? "[]";

            console.log("ðŸ“¦ pokedexData (raw):", json);

            let dex = [];
            try {
              dex = JSON.parse(json);
            } catch (e) {
              console.error("âŒ Failed to parse pokedex JSON:", e);
            }

            console.log("ðŸ“˜ Parsed userDex:", dex);
            console.log("ðŸ“Š Count:", dex.length);

            renderDex(dex);
          }
        };

        ws.onclose = () => {
          console.warn("ðŸ”´ WS CLOSED â€” reconnecting in 1s");
          document.getElementById("status").innerText =
            "Disconnected â€“ retryingâ€¦";
          setTimeout(connectWS, 1000);
        };
      }

      connectWS();

      //-------------------------------------------------------
      // RENDERING WITH DEBUGGING
      //-------------------------------------------------------
      function renderDex(userDex) {
        console.log("ðŸŽ¨ Rendering Dexâ€¦", userDex);

        const grid = document.getElementById("dex-grid");
        grid.innerHTML = "";

        // MAP BY POKEDEX NUMBER â€” YOUR STORED DATA HAS THIS
        const caughtMap = {};
        userDex.forEach((mon) => {
          caughtMap[mon.PokedexNum] = mon;
        });

        console.log("ðŸ“Œ caughtMap:", caughtMap);

        ALL_POKEMON.forEach((entry) => {
          const caught = caughtMap[entry.num];

          console.log(
            `âž¡ ${entry.num} ${entry.name}:`,
            caught ? "CAUGHT" : "NOT CAUGHT",
            caught
          );

          const cell = document.createElement("div");
          cell.className = "dex-entry " + (caught ? "caught" : "uncaught");

          if (caught?.Shiny) cell.classList.add("shiny");

          cell.innerHTML = `
            <img src="${SPRITE_BASE}${entry.name}.png">
            <div>#${entry.num}</div>
            <div>${entry.name}</div>
          `;

          grid.appendChild(cell);
        });

        console.log("ðŸŽ‰ RENDER COMPLETE");
      }
    </script>
  </body>
</html>
