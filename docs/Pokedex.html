<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>PokÃ©dex Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      body {
        background: #0a0a0a;
        color: #f5f5f5;
        font-family: "Inter", sans-serif;
        text-align: center;
        padding: 20px;
      }

      h1 {
        font-size: 2.5rem;
        margin-bottom: 5px;
      }

      #username-label {
        color: #ffcb05;
        margin-bottom: 6px;
        font-size: 1.2rem;
      }

      #status {
        margin-bottom: 10px;
        opacity: 0.8;
        font-size: 0.9rem;
      }

      /* Controls + progress */
      #controls {
        max-width: 1200px;
        margin: 0 auto 20px;
        text-align: left;
      }

      #progress-summary {
        font-size: 0.95rem;
        color: #ddd;
        margin-bottom: 10px;
      }

      .control-row {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
        align-items: center;
        justify-content: space-between;
      }

      .control-group {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        align-items: center;
      }

      .control-group label {
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.06em;
        color: #aaa;
      }

      .filter-button {
        background: #151515;
        color: #eee;
        border: 1px solid #444;
        border-radius: 999px;
        padding: 5px 12px;
        font-size: 0.85rem;
        cursor: pointer;
        transition: background 0.15s ease, border-color 0.15s ease,
          transform 0.1s ease;
      }

      .filter-button:hover {
        transform: translateY(-1px);
        border-color: #ffcb05;
      }

      .filter-button.active {
        border-color: #ffcb05;
        background: #262018;
        color: #fffbdd;
      }

      #search-input {
        padding: 6px 12px;
        border-radius: 999px;
        border: 1px solid #444;
        background: #111;
        color: #f5f5f5;
        font-size: 0.9rem;
        min-width: 190px;
      }

      #search-input:focus {
        outline: none;
        border-color: #ffcb05;
        box-shadow: 0 0 0 1px rgba(255, 203, 5, 0.4);
      }

      /* Grid */
      #dex-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 18px;
        max-width: 1200px;
        margin: 0 auto;
      }

      /* Cards */
      .dex-entry {
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 10px;
        padding: 10px;
        opacity: 0;
        transform: translateY(6px) scale(0.98);
        animation: cardIn 0.25s ease-out forwards;
        animation-delay: var(--delay, 0s);
      }

      .dex-entry.caught {
        border-color: #4caf50;
      }

      .dex-entry.shiny {
        border-color: gold;
        box-shadow: 0 0 10px gold;
      }

      .dex-entry img {
        width: 90px;
        height: 90px;
        object-fit: contain;
        filter: drop-shadow(0 0 4px rgba(255, 255, 255, 0.25));
      }

      .dex-entry.uncaught img {
        filter: grayscale(1) brightness(0.3);
        opacity: 0.4;
      }

      .dex-number {
        font-size: 0.9rem;
        opacity: 0.8;
      }

      .dex-name {
        font-size: 1rem;
        margin-top: 5px;
        margin-bottom: 4px;
        font-weight: 600;
      }

      .variant-tags {
        margin-top: 4px;
        font-size: 0.8rem;
        display: flex;
        flex-wrap: wrap;
        gap: 4px;
        justify-content: center;
      }

      .tag-pill {
        padding: 2px 6px;
        border-radius: 999px;
        border: 1px solid transparent;
        display: inline-flex;
        align-items: center;
        gap: 3px;
      }

      .tag-normal {
        color: #4caf50;
        border-color: #2e7d32;
        background: rgba(46, 125, 50, 0.15);
      }

      .tag-shiny {
        color: gold;
        border-color: #ffeb3b;
        background: rgba(255, 235, 59, 0.1);
      }

      .tag-amped {
        color: #ff9800;
        border-color: #f57c00;
        background: rgba(245, 124, 0, 0.1);
      }

      .tag-lowkey {
        color: #90caf9;
        border-color: #42a5f5;
        background: rgba(66, 165, 245, 0.12);
      }

      #empty-message {
        margin-top: 30px;
        font-size: 0.95rem;
        color: #aaa;
      }

      @keyframes cardIn {
        from {
          opacity: 0;
          transform: translateY(8px) scale(0.97);
        }
        to {
          opacity: 1;
          transform: translateY(0) scale(1);
        }
      }

      .footer {
        padding-bottom: 20px;
        padding-top: 50px;
        margin-top: 50px;
        border-top: 1px solid #333;
        font-size: 0.95rem;
        color: #ddd;
      }
    </style>
  </head>

  <body>
    <h1>RearSilver's Stream PokÃ©dex</h1>
    <div id="username-label"></div>
    <div id="status">Connecting to Professor Oakâ€¦</div>

    <div id="controls">
      <div id="progress-summary"></div>

      <div class="control-row">
        <div class="control-group">
          <label>Generation</label>
          <button
            class="filter-button gen-btn active"
            data-gen="all"
            type="button"
          >
            All
          </button>
          <button class="filter-button gen-btn" data-gen="1" type="button">
            Gen 1
          </button>
          <button class="filter-button gen-btn" data-gen="2" type="button">
            Gen 2
          </button>
          <button class="filter-button gen-btn" data-gen="3" type="button">
            Gen 3
          </button>
          <button class="filter-button gen-btn" data-gen="4" type="button">
            Gen 4
          </button>
          <button class="filter-button gen-btn" data-gen="5" type="button">
            Gen 5
          </button>
          <button class="filter-button gen-btn" data-gen="6" type="button">
            Gen 6
          </button>
          <button class="filter-button gen-btn" data-gen="7" type="button">
            Gen 7
          </button>
          <button class="filter-button gen-btn" data-gen="8" type="button">
            Gen 8
          </button>
        </div>

        <div class="control-group">
          <label>Show</label>
          <button
            class="filter-button mode-btn active"
            data-mode="all"
            type="button"
          >
            All
          </button>
          <button
            class="filter-button mode-btn"
            data-mode="caught"
            type="button"
          >
            Caught
          </button>
          <button
            class="filter-button mode-btn"
            data-mode="shiny"
            type="button"
          >
            Shiny
          </button>
        </div>

        <div class="control-group">
          <input
            id="search-input"
            type="text"
            placeholder="Search name or #25â€¦"
            autocomplete="off"
          />
        </div>
      </div>
    </div>

    <div id="dex-grid"></div>
    <div id="empty-message" style="display: none">
      No PokÃ©mon match your filters yet. Try changing generation, mode, or
      search.
    </div>

    <!-- Footer -->
    <footer class="footer">
      <div class="flex flex-wrap items-center justify-between gap-2 text-sm">
        <div>
          <a
            class="filter-button mode-btn"
            href="https://rearsilvergaming.github.io/Streamer-Tools"
            target="_blank"
            rel="noreferrer"
            >Streamer Toolkit</a
          >
          <a
            class="filter-button mode-btn"
            href="https://www.twitch.tv/rearsilver"
            target="_blank"
            rel="noreferrer"
            >RearSilver's Twitch</a
          >
          <a
            class="filter-button mode-btn"
            href="https://discord.gg/RRbQ93Ceew"
            target="_blank"
            rel="noreferrer"
            >RearSilver's Discord</a
          >
        </div>
        <br />
        <div>&copy; RearSilver 2025</div>
      </div>
    </footer>

    <script>
      console.log("ðŸ”¥ POKEDEX PAGE LOADED");

      const SPECIES_JSON_URL =
        "https://raw.githubusercontent.com/rearsilvergaming/Streamer-Tools/main/docs/Pokemon/PokemonList.json";

      function getParam(key) {
        return new URL(window.location.href).searchParams.get(key);
      }

      const user = getParam("user") || "Unknown";
      const userId = getParam("userId") || "";
      document.getElementById("username-label").innerText =
        "Showing PokÃ©dex for " + user;

      // State
      let allSpecies = [];
      let latestDex = [];
      let currentGenFilter = "all";
      let currentMode = "all";
      let searchTerm = "";

      // ---------- Load species JSON ----------
      fetch(SPECIES_JSON_URL)
        .then((r) => r.json())
        .then((data) => {
          allSpecies = (data || [])
            .slice()
            .sort((a, b) => a.PokedexNum - b.PokedexNum);
          console.log("ðŸ“š Loaded species list:", allSpecies);
          if (latestDex) {
            updateProgress(latestDex);
            renderDex(latestDex);
          }
        })
        .catch((err) => {
          console.error("âŒ Failed to load PokemonList.json", err);
        });

      // ---------- WebSocket to Streamer.bot ----------
      let ws;

      function connectWS() {
        console.log("ðŸ”Œ Opening WebSocketâ€¦");
        ws = new WebSocket("ws://127.0.0.1:8080");

        ws.onopen = () => {
          console.log("ðŸŸ¢ WEBSOCKET CONNECTED");
          document.getElementById("status").innerText =
            "Connected to Professor Oak using FrontSilver Systems Ltd.âœ”ï¸";

          const payload = {
            request: "TwitchGetUserGlobal",
            id: "pokedexRequest",
            userId: userId,
            variable: "pokedexData",
            persisted: true,
          };
          ws.send(JSON.stringify(payload));
        };

        ws.onmessage = (event) => {
          console.log("ðŸ“¥ RAW MESSAGE:", event.data);
          const msg = JSON.parse(event.data);

          if (msg.id === "pokedexRequest") {
            const dexRaw =
              (msg.variables && msg.variables[0] && msg.variables[0].value) ||
              "[]";
            console.log("ðŸ“¦ pokedexData raw:", dexRaw);

            let dex = [];
            try {
              dex = JSON.parse(dexRaw);
            } catch (e) {
              console.error("âŒ Failed to parse pokedexData JSON", e);
            }

            latestDex = dex;
            console.log("ðŸ“˜ Parsed userDex:", latestDex);

            if (allSpecies.length > 0) {
              updateProgress(latestDex);
              renderDex(latestDex);
            }
          }
        };

        ws.onclose = () => {
          console.warn("ðŸ”´ WebSocket closed â€“ reconnectingâ€¦");
          document.getElementById("status").innerText =
            "Disconnected â€“ reconnectingâ€¦";
          setTimeout(connectWS, 1000);
        };
      }

      connectWS();

      // ---------- Progress ----------
      function updateProgress(userDex) {
        const summary = document.getElementById("progress-summary");
        if (!summary || allSpecies.length === 0) return;

        const uniqueMap = {};
        userDex.forEach((mon) => {
          uniqueMap[mon.PokedexNum] = mon;
        });
        const uniqueList = Object.values(uniqueMap);

        const totalSpecies = allSpecies.length;
        const caughtCount = uniqueList.length;
        const shinySpecies = uniqueList.filter((m) => m.Shiny).length;

        const percent =
          totalSpecies > 0
            ? ((caughtCount / totalSpecies) * 100).toFixed(1)
            : "0.0";

        summary.textContent = `Caught ${caughtCount}/${totalSpecies} (${percent}%) â€¢ Shiny species: ${shinySpecies}`;
      }

      // ---------- Render ----------
      function renderDex(userDex) {
        const grid = document.getElementById("dex-grid");
        const emptyMessage = document.getElementById("empty-message");

        if (!grid || allSpecies.length === 0) return;

        grid.innerHTML = "";

        const caughtMap = {};
        userDex.forEach((mon) => {
          caughtMap[mon.PokedexNum] = mon;
        });

        let visibleCount = 0;

        allSpecies.forEach((entry, index) => {
          const gen = String(entry.Generation || entry.gen || "");
          const num = entry.PokedexNum || entry.num;
          const name = entry.Name || entry.name;

          // Gen filter
          if (currentGenFilter !== "all" && gen !== currentGenFilter) return;

          const caught = caughtMap[num];

          // Mode filter
          if (currentMode === "caught" && !caught) return;
          if (currentMode === "shiny" && !(caught && caught.Shiny)) return;

          // Search filter
          if (searchTerm) {
            const term = searchTerm.toLowerCase();
            const nameMatch = name.toLowerCase().includes(term);
            const numString = String(num);
            const numMatch =
              numString.includes(term.replace("#", "")) ||
              ("#" + numString).includes(term);
            if (!nameMatch && !numMatch) return;
          }

          const cell = document.createElement("div");
          cell.className = "dex-entry " + (caught ? "caught" : "uncaught");
          if (caught && caught.Shiny) cell.classList.add("shiny");

          // animated delay
          cell.style.setProperty(
            "--delay",
            (visibleCount * 0.03).toString() + "s"
          );

          // Variant tags
          const tagsHtml = [];

          if (caught && caught.Normal) {
            tagsHtml.push(`<span class="tag-pill tag-normal">âœ“ Normal</span>`);
          }
          if (caught && caught.Shiny) {
            tagsHtml.push(`<span class="tag-pill tag-shiny">âœ¨ Shiny</span>`);
          }
          if (caught && caught.Amped) {
            tagsHtml.push(`<span class="tag-pill tag-amped">âš¡ Amped</span>`);
          }
          if (caught && caught.LowKey) {
            tagsHtml.push(
              `<span class="tag-pill tag-lowkey">ðŸŽµ Low Key</span>`
            );
          }

          cell.innerHTML = `
            <img 
  src="${SPRITE_BASE}${name}.png" 
  alt="${name}"
  onerror="this.onerror=null; this.src='https://raw.githubusercontent.com/rearsilvergaming/Streamer-Tools/main/docs/Pokemon/Missing%20Image.png';"
/>

            <div class="dex-number">#${num}</div>
            <div class="dex-name">${name}</div>
            <div class="variant-tags">${tagsHtml.join("")}</div>
          `;

          grid.appendChild(cell);
          visibleCount++;
        });

        if (visibleCount === 0) {
          emptyMessage.style.display = "block";
        } else {
          emptyMessage.style.display = "none";
        }
      }

      const SPRITE_BASE =
        "https://raw.githubusercontent.com/rearsilvergaming/Streamer-Tools/main/docs/Pokemon/";

      // ---------- UI handlers ----------
      const genButtons = document.querySelectorAll(".gen-btn");
      genButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          genButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentGenFilter = btn.dataset.gen;
          renderDex(latestDex);
        });
      });

      const modeButtons = document.querySelectorAll(".mode-btn");
      modeButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          modeButtons.forEach((b) => b.classList.remove("active"));
          btn.classList.add("active");
          currentMode = btn.dataset.mode;
          renderDex(latestDex);
        });
      });

      const searchInput = document.getElementById("search-input");
      searchInput.addEventListener("input", () => {
        searchTerm = searchInput.value.trim();
        renderDex(latestDex);
      });
    </script>
  </body>
</html>
