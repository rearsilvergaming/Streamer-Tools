<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Pokédex Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <style>
      body {
        background: #0a0a0a;
        color: white;
        font-family: "Inter", sans-serif;
        text-align: center;
        padding: 20px;
      }
      h1 {
        font-size: 2.5rem;
        margin-bottom: 5px;
      }
      #username-label {
        color: #ffcb05;
        margin-bottom: 25px;
        font-size: 1.2rem;
      }
      #status {
        margin-bottom: 20px;
        opacity: 0.8;
      }
      #dex-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 18px;
        max-width: 1200px;
        margin: 0 auto;
      }
      .dex-entry {
        background: #1a1a1a;
        border: 2px solid #333;
        border-radius: 10px;
        padding: 10px;
      }
      .dex-entry.caught {
        border-color: #4caf50;
      }
      .dex-entry.shiny {
        border-color: gold;
        box-shadow: 0 0 10px gold;
      }
      img {
        width: 90px;
        height: 90px;
        object-fit: contain;
      }
      .uncaught img {
        filter: grayscale(1) brightness(0.3);
        opacity: 0.4;
      }
    </style>
  </head>

  <body>
    <h1>Pokédex</h1>
    <div id="username-label"></div>
    <div id="status">Connecting to Streamer.bot…</div>
    <div id="dex-grid"></div>

    <script>
      // -------- CONFIG ----------
      const SPRITE_BASE =
        "https://raw.githubusercontent.com/rearsilvergaming/Streamer-Tools/main/docs/Pokemon/";
      const ALL_POKEMON = [
        { num: 1, name: "Bulbasaur" },
        { num: 4, name: "Charmander" },
        { num: 5, name: "Charmeleon" },
        { num: 6, name: "Charizard" },
        { num: 7, name: "Squirtle" },
        { num: 16, name: "Pidgey" },
        { num: 18, name: "Pidgeot" },
        { num: 25, name: "Pikachu" },
        { num: 35, name: "Clefairy" },
        { num: 39, name: "Jigglypuff" },
        { num: 52, name: "Meowth" },
        { num: 54, name: "Psyduck" },
        { num: 59, name: "Arcanine" },
        { num: 79, name: "Slowpoke" },
        { num: 94, name: "Gengar" },
        { num: 132, name: "Ditto" },
        { num: 133, name: "Eevee" },
        { num: 143, name: "Snorlax" },
        { num: 149, name: "Dragonite" },
        { num: 150, name: "Mewtwo" },
        { num: 151, name: "Mew" },
        { num: 197, name: "Umbreon" },
        { num: 727, name: "Incineroar" },
        { num: 778, name: "Mimikyu" },
      ];

      function getParam(key) {
        return new URL(window.location.href).searchParams.get(key);
      }

      const user = getParam("user") || "Unknown";
      const userId = getParam("userId") || "";
      document.getElementById("username-label").innerText =
        "Showing Pokédex for " + user;

      // -------- WEBSOCKET ----------
      let ws;

      function connectWS() {
        ws = new WebSocket("ws://127.0.0.1:8080");

        ws.onopen = () => {
          document.getElementById("status").innerText = "Connected ✔️";

          ws.send(
            JSON.stringify({
              request: "TwitchGetUserGlobal",
              id: "pokedexRequest",
              userId: userId,
              variable: "pokedexData",
              persisted: true,
            })
          );
        };

        ws.onmessage = (event) => {
          let msg = JSON.parse(event.data);

          if (msg.id === "pokedexRequest") {
            let json = msg.data?.value ?? "[]";
            let dex = [];

            try {
              dex = JSON.parse(json);
            } catch {}

            renderDex(dex);
          }
        };

        ws.onclose = () => {
          document.getElementById("status").innerText =
            "Disconnected — reconnecting…";
          setTimeout(connectWS, 1000);
        };
      }

      connectWS();

      // -------- RENDER ----------
      function renderDex(userDex) {
        const grid = document.getElementById("dex-grid");
        grid.innerHTML = "";

        // FIXED: match by NAME, not number
        const caughtMap = {};
        userDex.forEach((mon) => (caughtMap[mon.Pokemon] = mon));

        ALL_POKEMON.forEach((entry) => {
          const caught = caughtMap[entry.name];

          const cell = document.createElement("div");
          cell.className = "dex-entry " + (caught ? "caught" : "uncaught");
          if (caught?.Shiny) cell.classList.add("shiny");

          cell.innerHTML = `
            <img src="${SPRITE_BASE}${entry.name}.png">
            <div>#${entry.num}</div>
            <div>${entry.name}</div>
          `;

          grid.appendChild(cell);
        });
      }
    </script>
  </body>
</html>
