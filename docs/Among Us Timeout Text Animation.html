<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Timeout Eject Animation</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=VT323&display=swap");

    html, body {
      width: 100%;
      height: 100%;
      margin: 0;
      padding: 0;
      background: transparent;
      overflow: visible !important; /* prevent OBS clipping */
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      transform: translateZ(0); /* fix CEF layer clipping */
      padding-bottom: 2vh; /* small safety gap */
    }

    .eject-line {
      font-family: "VT323", monospace;
      font-size: 5rem;
      color: #fff;
      letter-spacing: 0.15em;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 4px 4px 0 #000;
      line-height: 1.25;
      text-align: center;
      width: 100%;
      margin: 0;
    }

    .eject-inner {
      display: inline-block;
      white-space: nowrap;
      overflow: hidden;
      vertical-align: bottom;
      transform: translateZ(0); /* helps with OBS clipping */
    }

    .cursor::after {
      content: "";
      display: inline-block;
      width: 0.15em;
      height: 1em;
      background: white;
      margin-left: 0.05em;
      animation: blink-caret 0.75s step-end infinite;
    }

    @keyframes blink-caret {
      from, to { opacity: 0; }
      50% { opacity: 1; }
    }

    .username { color: #ff5050; }
    .mod { color: #50b3ff; }
    .duration { color: #ffff50; }
    .reason { color: #a0ff90; }
  </style>
</head>

<body>
  <div id="parent-container" class="transition-opacity duration-500">
    <div id="line-one" class="eject-line"><span class="eject-inner"></span></div>
    <div id="line-two" class="eject-line"><span class="eject-inner"></span></div>
    <div id="line-three" class="eject-line reason"><span class="eject-inner"></span></div>
    <div id="line-four" class="eject-line"><span class="eject-inner"></span></div>
  </div>

  <script>
    function decodeBase64(str) {
      try {
        return decodeURIComponent(
          atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
        );
      } catch { return str; }
    }

    const params = new URLSearchParams(window.location.search);
    const username = decodeBase64(params.get("user") || "A user");
    const mod = decodeURIComponent(params.get("createdByDisplayName") || "a Moderator");
    const duration = decodeURIComponent(params.get("duration") || "300s");
    const reason = decodeURIComponent(params.get("reason") || "No reason given.");

    const lines = [
      { el: document.querySelector("#line-one .eject-inner"), html: `<span class="username">${username}</span> was timed out` },
      { el: document.querySelector("#line-two .eject-inner"), html: `By <span class="mod">${mod}</span> for <span class="duration">${duration}</span>` },
      { el: document.querySelector("#line-three .eject-inner"), html: reason },
      { el: document.querySelector("#line-four .eject-inner"), html: "" },
    ];

    const CHAR_DELAY_S = 0.09;
    const CURSOR_STOP_DELAY_MS = 500;
    const HOLD_TIME_MS = 5000;
    const FADE_TIME_MS = 500;
    const OBS_WIDTH = 1920;
    const OBS_PADDING = 60;

    function typeLine(index) {
      if (index >= lines.length) return startCleanup();

      const el = lines[index].el;
      const content = lines[index].html;
      el.innerHTML = content;

      const numSteps = el.textContent.length;

      // Skip animation if no text
      if (numSteps === 0) {
        el.classList.remove("cursor");
        setTimeout(() => typeLine(index + 1), CURSOR_STOP_DELAY_MS);
        return;
      }

      el.classList.add("cursor");

      const fullWidth = Math.min(el.offsetWidth, OBS_WIDTH - OBS_PADDING);
      el.style.width = "0px";

      const typingAnim = el.animate(
        [{ width: "0px" }, { width: `${fullWidth}px` }],
        {
          duration: numSteps * CHAR_DELAY_S * 1000,
          easing: `steps(${Math.max(1, numSteps)}, end)`,
          fill: "forwards"
        }
      );

      typingAnim.onfinish = () => {
        el.classList.remove("cursor");
        el.style.width = `${fullWidth}px`;
        setTimeout(() => typeLine(index + 1), CURSOR_STOP_DELAY_MS);
      };
    }

    function startCleanup() {
      const parentContainer = document.getElementById("parent-container");
      setTimeout(() => {
        parentContainer.style.opacity = "0";
        setTimeout(() => (parentContainer.style.display = "none"), FADE_TIME_MS);
      }, HOLD_TIME_MS);
    }

    typeLine(0);
  </script>
</body>
</html>
