<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timeout Eject Animation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=VT323&display=swap");

      body {
        background: transparent;
        margin: 0;
        padding: 0;
      }

      #parent-container {
        text-align: center;
        opacity: 1;
        transition: opacity 0.5s ease;
        padding-bottom: 40px; /* Prevents cutoff at bottom */
      }

      .eject-line {
        font-family: "VT323", monospace;
        font-size: 5rem;
        color: #fff;
        white-space: nowrap;
        overflow: hidden;
        letter-spacing: 0.15em;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 4px 4px 0 #000;
        margin: 0 0 0.5em 0;
        line-height: 1.2;
        display: block;
        width: fit-content;
        margin-left: auto;
        margin-right: auto;
      }

      .cursor {
        border-right: 0.15em solid white;
        animation: blink-caret 0.75s step-end infinite;
      }

      @keyframes blink-caret {
        from, to { border-color: transparent; }
        50% { border-color: white; }
      }

      .username { color: #ff5050; }
      .mod { color: #50b3ff; }
      .duration { color: #ffff50; }
      .reason { color: #a0ff90; }
    </style>
  </head>

  <body>
    <div id="parent-container">
      <div id="line-one" class="eject-line"></div>
      <div id="line-two" class="eject-line"></div>
      <div id="line-three" class="eject-line reason"></div>
      <div id="line-four" class="eject-line"></div>
    </div>

    <script>
      function decodeBase64(str) {
        try {
          return decodeURIComponent(
            atob(str).split('').map(c => '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2)).join('')
          );
        } catch { return str; }
      }

      const params = new URLSearchParams(window.location.search);
      const username = decodeBase64(params.get("user") || "A user");
      const mod = decodeURIComponent(params.get("createdByDisplayName") || "a Moderator");
      const duration = decodeURIComponent(params.get("duration") || "300s");
      const reason = decodeURIComponent(params.get("reason") || "No reason given.");

      const elOne = document.getElementById("line-one");
      const elTwo = document.getElementById("line-two");
      const elThree = document.getElementById("line-three");
      const elFour = document.getElementById("line-four");
      const parentContainer = document.getElementById("parent-container");

      const lineOneHTML = `<span class="username">${username}</span> was timed out`;
      const lineTwoHTML = `By <span class="mod">${mod}</span> for <span class="duration">${duration}</span>`;
      const lineThreeText = reason;
      const lineFourText = "";

      const CHAR_DELAY_S = 0.09;
      const CURSOR_STOP_DELAY_MS = 500;
      const HOLD_TIME_MS = 5000;
      const FADE_TIME_MS = 500;
      const OBS_WIDTH = 1920;
      const OBS_PADDING = 80;

      async function waitForFont() {
        if (document.fonts && document.fonts.ready) {
          await document.fonts.ready;
        } else {
          return new Promise(res => setTimeout(res, 500));
        }
      }

      function typeLine(el, content, nextFunction) {
        el.innerHTML = content;
        const numSteps = el.textContent.length || 1;
        el.style.display = "inline-block";

        // Force layout before measuring
        void el.offsetWidth;
        let finalWidth = el.offsetWidth || (content.length * 24);
        finalWidth = Math.min(finalWidth, OBS_WIDTH - OBS_PADDING);

        el.style.display = "block";
        el.style.width = "0px";
        el.classList.add("cursor");

        const typingAnim = el.animate(
          [{ width: "0px" }, { width: `${finalWidth}px` }],
          {
            duration: numSteps * CHAR_DELAY_S * 1000,
            easing: `steps(${numSteps}, end)`,
            fill: "forwards"
          }
        );

        typingAnim.onfinish = () => {
          el.classList.remove("cursor");
          el.style.width = `${finalWidth}px`;
          setTimeout(nextFunction, CURSOR_STOP_DELAY_MS);
        };
      }

      function typeLineOne() { typeLine(elOne, lineOneHTML, typeLineTwo); }
      function typeLineTwo() { typeLine(elTwo, lineTwoHTML, typeLineThree); }
      function typeLineThree() { typeLine(elThree, lineThreeText, typeLineFour); }
      function typeLineFour() { typeLine(elFour, lineFourText, startCleanup); }

      function startCleanup() {
        elFour.classList.add("cursor");
        setTimeout(() => {
          elFour.classList.remove("cursor");
          parentContainer.style.opacity = "0";
          setTimeout(() => parentContainer.style.display = "none", FADE_TIME_MS);
        }, HOLD_TIME_MS);
      }

      (async function start() {
        await waitForFont();
        await new Promise(res => setTimeout(res, 200)); // let OBS stabilise
        typeLineOne();
      })();
    </script>
  </body>
</html>
