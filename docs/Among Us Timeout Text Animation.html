<!DOCTYPE html>
<html lang="en">
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Timeout Eject Animation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Integrated VT323 font from Ban Code */
      @import url("https://fonts.googleapis.com/css2?family=VT323&display=swap");

      /* Styles common to all animated lines, adapted from eject-line */
      .eject-line {
        font-family: "VT323", monospace;
        font-size: 5rem;
        color: #fff;
        /* These three rules are crucial for the typing effect: */
        white-space: nowrap; 
        overflow: hidden; 
        width: 0; /* Starts with zero width for animation */
        
        letter-spacing: 0.15em;
        text-shadow: 0 0 10px rgba(255, 255, 255, 0.7), 4px 4px 0 #000;
        
        /* Margin adjustment for spacing and to prevent cut-off */
        margin: 0 0 0.5em 0; 
        padding: 0; 
        line-height: 1.2; 
      }

      /* The cursor style (only applied dynamically to the active line) */
      .cursor {
        border-right: 0.15em solid white;
      }

      /* Keyframes for the blinking cursor */
      @keyframes blink-caret {
        from,
        to {
          border-color: transparent;
        }
        50% {
          border-color: white;
        }
      }
      
      /* Colouring styles from the original Timeout code */
      .username {
        color: #ff5050;
      }
      .mod {
        color: #50b3ff;
      }
      .duration {
        color: #ffff50;
      }
      .reason {
        color: #a0ff90;
      }
    </style>
  </head>
  <body class="bg-transparent flex items-center justify-center min-h-screen">
    <div
      id="parent-container"
      class="text-center transition-opacity duration-500"
    >
      <div id="line-one" class="eject-line"></div>
      <div id="line-two" class="eject-line"></div>
      <div id="line-three" class="eject-line reason"></div>
      <div id="line-four" class="eject-line"></div>
    </div>

    <script>
      // --- Utility Functions ---
      function decodeBase64(str) {
        try {
          return decodeURIComponent(
            atob(str)
              .split("")
              .map((c) => "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2))
              .join("")
          );
        } catch {
          return str; // fallback if not valid base64
        }
      }
      
      // --- Get Parameters and Define Content ---
      const params = new URLSearchParams(window.location.search);
      
      let rawUser = params.get("user") || "A user";
      let username = decodeBase64(rawUser); 

      const mod = decodeURIComponent(
        params.get("createdByDisplayName") || "a Moderator"
      );
      
      const duration = decodeURIComponent(params.get("duration") || "300s");
      const reason = decodeURIComponent(
        params.get("reason") || "No reason given."
      );

      // --- Define element references ---
      const elOne = document.getElementById("line-one");
      const elTwo = document.getElementById("line-two");
      const elThree = document.getElementById("line-three");
      const elFour = document.getElementById("line-four");
      const parentContainer = document.getElementById("parent-container");
      
      // --- Define Line Content (including HTML for colour) ---
      const lineOneHTML = `<span class="username">${username}</span> was timed out`;
      const lineTwoHTML = `By <span class="mod">${mod}</span> for <span class="duration">${duration}</span>`;
      const lineThreeText = reason;
      const lineFourText = ""; 

      // --- Animation Constants ---
      const CHAR_DELAY_S = 0.09;
      const CURSOR_STOP_DELAY_MS = 500;
      const HOLD_TIME_MS = 5000;
      const FADE_TIME_MS = 500;

      // --- Animation Core Logic ---

      /**
       * Generic function to type out a single line using WAAPI for width animation.
       * @param {HTMLElement} el - The line element to type.
       * @param {string} content - The HTML/Text content to insert and type out.
       * @param {function} nextFunction - The function to call after this line is typed.
       */
      function typeLine(el, content, nextFunction) {
        // 1. Insert content just before typing starts
        el.innerHTML = content;
        
        // 2. We use the length of the *text content* to determine the steps.
        const numSteps = el.textContent.length; 
        
        // --- CRITICAL FIX: Skip animation if the line is empty (numSteps === 0) ---
        if (numSteps === 0) {
            el.classList.add("cursor");
            el.style.width = "fit-content";
            el.style.animation = `blink-caret 0.75s step-end infinite`;

            // Proceed to the next step after a very short pause for visual effect
            setTimeout(() => {
                el.classList.remove("cursor");
                el.style.borderRight = "none";
                el.style.animation = "none";
                nextFunction(); 
            }, CURSOR_STOP_DELAY_MS);
            return; // Exit the function to prevent the crash
        }
        // --------------------------------------------------------------------------

        // Continue with animation for non-empty lines
        const typingDuration = numSteps * CHAR_DELAY_S;
        
        // Temporarily set width to content to measure it
        el.style.width = 'fit-content';
        const finalWidth = el.offsetWidth;
        el.style.width = '0'; // Reset width for animation start
        
        el.classList.add("cursor");

        // Use the Web Animation API (WAAPI) for a robust typing animation
        const typingAnim = el.animate(
          [
            { width: '0' },
            { width: `${finalWidth}px` }
          ],
          {
            duration: typingDuration * 1000,
            easing: `steps(${numSteps}, end)`,
            fill: 'forwards'
          }
        );

        typingAnim.onfinish = () => {
          // Stop cursor blink and remove cursor style
          el.classList.remove("cursor");
          el.style.borderRight = "none";
          el.style.animation = "none";
          el.style.width = `${finalWidth}px`; // Ensure it holds the final width
          
          // Add a short delay after typing stops before moving to the next line
          setTimeout(nextFunction, CURSOR_STOP_DELAY_MS); 
        };
      }
      
      // Define the sequence of line typing
      
      function typeLineOne() {
        typeLine(elOne, lineOneHTML, typeLineTwo);
      }

      function typeLineTwo() {
        typeLine(elTwo, lineTwoHTML, typeLineThree);
      }

      function typeLineThree() {
        typeLine(elThree, lineThreeText, typeLineFour);
      }
      
      function typeLineFour() {
        typeLine(elFour, lineFourText, startCleanup);
      }

      // --- Fade Out ---
      function startCleanup() {
        // Line 4 is the final empty line, ensure the cursor blinks for the HOLD_TIME_MS
        elFour.classList.add("cursor");
        elFour.style.animation = `blink-caret 0.75s step-end infinite`;
        
        setTimeout(() => {
          elFour.classList.remove("cursor"); // Remove cursor before starting fade
          parentContainer.style.opacity = "0"; 

          setTimeout(() => {
            parentContainer.style.display = "none";
          }, FADE_TIME_MS);
        }, HOLD_TIME_MS);
      }

      // --- Start Sequence ---
      typeLineOne();
    </script>
  </body>
</html>
